name: Release

on:
  push:
    tags:
      - 'v*'
  release:
    types: [created]

jobs:
  test-before-release:
    name: Test Before Release
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'

    - name: Install dependencies
      run: go mod download

    - name: Run tests
      run: |
        go test -v ./internal/config ./internal/testutil ./internal/types

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: test-before-release
    if: startsWith(github.ref, 'refs/tags/')
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract tag name
      id: tag
      run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## NER Service Go ${{ steps.tag.outputs.tag }}
        
        ### ðŸš€ Features
        - Named Entity Recognition for Spanish text using MITIE
        - HTTP API server with flexible input support (JSON, form-data, multipart)
        - Command-line interface with file input and JSON output options
        - Docker image with Spanish models included
        
        ### ðŸ³ Quick Start with Docker
        ```bash
        docker run -p 8080:8080 drzippie/ner-service:${{ steps.tag.outputs.tag }}
        curl -X POST http://localhost:8080/ner \
          -H "Content-Type: application/json" \
          -d '{"text": "MarÃ­a GarcÃ­a vive en Madrid y trabaja en Google EspaÃ±a."}'
        ```
        
        ### ðŸ“‹ Requirements
        - For binaries: MITIE library must be installed separately
        - For Docker: No additional requirements
        
        ### ðŸ“š Documentation
        - [README](https://github.com/your-repo/ner-service-go/blob/main/README.md)
        - [Testing Guide](https://github.com/your-repo/ner-service-go/blob/main/TESTING.md)
        
        ---
        Built with Go 1.24+ and MITIE Spanish models
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.tag.outputs.tag }}
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}